---
- name: Bootstrap development environment
  hosts: localhost

  tasks:
  - name: Add apt repositories
    tags:
      - deps
      - apt
    loop:
      - "ppa:papirus/papirus"
    apt_repository:
      repo: "{{ item }}"
      state: present

  - name: Install apt packages
    tags:
      - deps
      - apt
    become: true
    apt:
      name:
        - git
        - tig
        - tmux
        - fzf
        - stow
        - nodejs
        - mutt
        - w3m
        - offlineimap
        - abook
        - mpv
        - ripgrep
        - scrot
        - sxiv
        - zathura
        - fd-find
        - numlockx
        - jq
        - shellcheck
        - peek
        - scrcpy
        - tlp
        - htop
        - papirus-icon-theme
      state: present

  - name: Install pip packages
    tags:
      - deps
      - pip
    pip:
      name:
        - pywal
        - ranger-fm
        - ueberzug
        - urlscan
        - flake8
        - black
        - yamllint
      state: present
      executable: pip3

  - name: Install npm packages
    tags:
      - deps
      - npm
    loop:
      - n
      - eslint_d
      - prettier
    community.general.npm:
      name: "{{ item }}"
      state: present
      global: true

  - name: Build neovim from source
    tags:
      - deps
      - neovim
    vars:
      clone_path: "{{ ansible_env.HOME }}/src/neovim"
    block:
      - name: Install system dependencies
        apt:
          name:
            - ninja-build
            - gettext
            - libtool
            - libtool-bin
            - autoconf
            - automake
            - cmake
            - g++
            - pkg-config
            - unzip
            - curl
          state: present

      - name: Clone neovim repository
        git:
          repo: https://github.com/neovim/neovim
          dest: "{{ clone_path }}"
          clone: true
          version: v0.5.0

      - name: Build release version
        community.general.make:
          chdir: "{{ clone_path }}"
          params:
            CMAKE_BUILD_TYPE: Release

      - name: Install release version
        become: true
        community.general.make:
          chdir: "{{ clone_path }}"
          target: install

  - name: Initialize git submodules
    tags:
      - deps
      - submodules
    command: git submodule update --init --recursive --jobs 4

  - name: Build dunst from source
    tags:
      - deps
      - dunst
    vars:
      clone_path: "{{ ansible_env.HOME }}/src/dunst"
    block:
      - name: Install system dependencies
        apt:
          name:
            - libdbus-1-dev
            - libx11-dev
            - libxinerama-dev
            - libxrandr-dev
            - libxss-dev
            - libglib2.0-dev
            - libpango1.0-dev
            - libgtk-3-dev
            - libxdg-basedir-dev
          state: present

      - name: Clone dunst repository
        git:
          repo: https://github.com/dunst-project/dunst
          dest: "{{ clone_path }}"
          clone: true
          version: v1.6.1

      - name: Build
        community.general.make:
          chdir: "{{ clone_path }}"

      - name: Install
        become: true
        community.general.make:
          chdir: "{{ clone_path }}"
          target: install

  - name: Run pywal
    tags:
      - pywal
    command: wal --theme custom-base16-railscasts -o .config/wal/done.sh

  - name: Build suckless tools
    tags:
      - suckless
    loop:
      - dmenu
      - dwm
      - slock
      - st
      - tabbed
    shell:
      cmd: make clean install
      chdir: "./suckless/{{ item }}"
    become: true

  - name: Run Stow
    tags:
      - stow
    # TODO: remove .bashrc and other files that may already exist
    shell: "stow . --target {{ ansible_env.HOME }} --verbose=2"
    register: result
    changed_when: 'result.stderr is search("LINK: ")'

  - name: Configure DWM X Session
    tags:
      - dwm
    template:
      src: templates/dwm.desktop.j2
      dest: /usr/share/xsessions/dwm.desktop
    become: true

  - name: Install Font Awesome
    tags:
      - fonts
      - deps
    get_url:
      url: https://github.com/FortAwesome/Font-Awesome/blob/7d3d774145ac38663f6d1effc6def0334b68ab7e/otfs/Font%20Awesome%205%20Free-Solid-900.otf?raw=true
      dest: "{{ ansible_env.HOME }}/.local/share/fonts/Font Awesome 5 Free-Solid-900.otf"
      checksum: md5:8d531d92051cddac77556d0734b701f8

  - name: Install Source Code Pro
    tags:
      - fonts
      - deps
    get_url:
      url: https://github.com/adobe-fonts/source-code-pro/blob/29fdb884c6e9dc2a312f4a5e2bb3b2dad2350777/TTF/SourceCodePro-Semibold.ttf?raw=true
      dest: "{{ ansible_env.HOME }}/.local/share/fonts/SourceCodePro-Semibold.ttf"
      checksum: md5:0a182fd5b03b7bc3bbc99a57ae8d8a45

  - name: Update font cache
    tags:
      - fonts
    command: fc-cache -f

  - name: Install Go
    tags:
      - always
    include_role:
      name: fubarhouse.golang
      apply:
        tags:
          - go
    vars:
      go_version: 1.17
      go_install_clean: true
      go_install_clean_full: false

  - name: Install Go packages
    tags:
      - go
      - deps
    loop:
      - github.com/mattn/efm-langserver@v0.0.37
      - github.com/gohugoio/hugo@v0.88.1
    command: "go install {{ item }}"

  - name: Start third-party systemd system services
    tags:
      - systemd
    loop:
      - tlp
    systemd:
      name: "{{ item }}"
      state: started
      scope: system

  - name: Start third-party systemd user services
    tags:
      - systemd
    loop:
      - dunst
      - redshift
    systemd:
      name: "{{ item }}"
      state: started
      scope: user
