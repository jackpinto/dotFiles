---
- name: Bootstrap development environment
  hosts: localhost

  tasks:
  - name: Install apt packages
    tags:
      - packages
      - apt
    become: yes
    when: ansible_facts['distribution'] == "Ubuntu"
    apt:
      name:
        - git
        - tig
        - tmux
        - fzf
        - stow
        - nodejs
        - mutt
        - w3m
        - offlineimap
        - abook
        - mpv
        - ripgrep
        - scrot
        - sxiv
        - zathura
        - fd-find
        - numlockx
        - jq
        - shellcheck
        - peek
        - scrcpy
        - tlp
        - htop
      state: present

  - name: Install pip packages
    tags:
      - packages
      - pip
    pip:
      name:
        - pywal
        - ranger-fm
        - ueberzug
        - urlscan
        - flake8
        - black
        - yamllint
      state: present
      executable: pip3

  - name: Install npm packages
    tags:
      - packages
      - npm
    loop:
      - n
      - eslint_d
      - prettier
    community.general.npm:
      name: "{{ item }}"
      state: present
      global: yes

  - name: Run pywal
    tags:
      - setup
      - pywal
    command: wal --theme custom-base16-railscasts

  - name: Build suckless tools
    tags:
      - setup
      - suckless
    loop:
      - dmenu
      - dwm
      - slock
      - st
      - tabbed
    community.general.make:
      target: install
      chdir: "./suckless/{{ item }}"
    become: yes

  - name: Run Stow
    tags:
      - setup
      - stow
    # TODO: remove .bashrc and other files that may already exist
    shell: "stow . --target {{ ansible_env.HOME }} --verbose=2"
    register: result
    changed_when: 'result.stderr is search("LINK: ")'

  - name: Configure DWM X Session
    tags:
      - setup
      - dwm
    template:
      src: templates/dwm.desktop.j2
      dest: /usr/share/xsessions/dwm.desktop
    become: yes

  - name: Install Font Awesome
    tags:
      - fonts
    get_url:
      url: https://github.com/FortAwesome/Font-Awesome/blob/7d3d774145ac38663f6d1effc6def0334b68ab7e/otfs/Font%20Awesome%205%20Free-Solid-900.otf?raw=true
      dest: "{{ ansible_env.HOME }}/.local/share/fonts/Font Awesome 5 Free-Solid-900.otf"
      checksum: md5:8d531d92051cddac77556d0734b701f8

  - name: Update font cache
    tags:
      - fonts
    command: fc-cache -f

  # TODO: install go and efm-langserver
  # TODO: install Source Code Pro. See https://askubuntu.com/a/193073
  # TODO: start tlp if it's not yet started
