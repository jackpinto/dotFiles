---
- name: Bootstrap development environment
  hosts: localhost

  tasks:
  - name: Install apt packages
    tags:
      - packages
      - apt
    become: true
    apt:
      name:
        - git
        - tig
        - tmux
        - fzf
        - stow
        - nodejs
        - mutt
        - w3m
        - offlineimap
        - abook
        - mpv
        - ripgrep
        - scrot
        - sxiv
        - zathura
        - fd-find
        - numlockx
        - jq
        - shellcheck
        - peek
        - scrcpy
        - tlp
        - htop
        - dunst
      state: present

  - name: Install pip packages
    tags:
      - packages
      - pip
    pip:
      name:
        - pywal
        - ranger-fm
        - ueberzug
        - urlscan
        - flake8
        - black
        - yamllint
      state: present
      executable: pip3

  - name: Install npm packages
    tags:
      - packages
      - npm
    loop:
      - n
      - eslint_d
      - prettier
    community.general.npm:
      name: "{{ item }}"
      state: present
      global: true

  - name: Initialize git submodules
    tags:
      - packages
      - submodules
    command: git submodule update --init --recursive --jobs 4

  - name: Run pywal
    tags:
      - pywal
    command: wal --theme custom-base16-railscasts -o .config/wal/done.sh

  - name: Build suckless tools
    tags:
      - suckless
    loop:
      - dmenu
      - dwm
      - slock
      - st
      - tabbed
    shell:
      cmd: make clean install
      chdir: "./suckless/{{ item }}"
    become: true

  - name: Run Stow
    tags:
      - stow
    # TODO: remove .bashrc and other files that may already exist
    shell: "stow . --target {{ ansible_env.HOME }} --verbose=2"
    register: result
    changed_when: 'result.stderr is search("LINK: ")'

  - name: Configure DWM X Session
    tags:
      - dwm
    template:
      src: templates/dwm.desktop.j2
      dest: /usr/share/xsessions/dwm.desktop
    become: true

  - name: Install Font Awesome
    tags:
      - fonts
    get_url:
      url: https://github.com/FortAwesome/Font-Awesome/blob/7d3d774145ac38663f6d1effc6def0334b68ab7e/otfs/Font%20Awesome%205%20Free-Solid-900.otf?raw=true
      dest: "{{ ansible_env.HOME }}/.local/share/fonts/Font Awesome 5 Free-Solid-900.otf"
      checksum: md5:8d531d92051cddac77556d0734b701f8

  - name: Install Source Code Pro
    tags:
      - fonts
    get_url:
      url: https://github.com/adobe-fonts/source-code-pro/blob/29fdb884c6e9dc2a312f4a5e2bb3b2dad2350777/TTF/SourceCodePro-Semibold.ttf?raw=true
      dest: "{{ ansible_env.HOME }}/.local/share/fonts/SourceCodePro-Semibold.ttf"
      checksum: md5:0a182fd5b03b7bc3bbc99a57ae8d8a45

  - name: Update font cache
    tags:
      - fonts
    command: fc-cache -f

  - name: Install Go
    tags:
      - always
    include_role:
      name: fubarhouse.golang
      apply:
        tags:
          - go
    vars:
      go_version: 1.17
      go_install_clean: true
      go_install_clean_full: false

  - name: Install Go packages
    tags:
      - go
      - packages
    loop:
      - github.com/mattn/efm-langserver@v0.0.37
      - github.com/gohugoio/hugo@v0.88.1
    command: "go install {{ item }}"

  - name: Start third-party systemd system services
    tags:
      - systemd
    loop:
      - tlp
    systemd:
      name: "{{ item }}"
      state: started
      scope: system

  - name: Start third-party systemd user services
    tags:
      - systemd
    loop:
      - dunst
      - redshift
    systemd:
      name: "{{ item }}"
      state: started
      scope: user
